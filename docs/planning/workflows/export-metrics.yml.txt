name: Export Metrics to Business (Template)

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 7 * * *'

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: python -m pip install --upgrade pip
      - name: Compute metrics
        run: |
          python docs/tools/generate_repo_metrics.py . > /tmp/metrics.json
      - name: Create PR to business repo
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_TOKEN }}
        run: |
          repo_owner=org
          business_repo=genesis-business
          branch=metrics/update-${{ github.repository_owner }}-${{ github.event.repository.name }}
          dest_path=metrics/${{ github.event.repository.name }}/metrics.json
          git clone https://github.com/$repo_owner/$business_repo.git /tmp/business
          cd /tmp/business
          git config user.name "metrics-bot"
          git config user.email "metrics-bot@users.noreply.github.com"
          git checkout -b "$branch"
          mkdir -p "$(dirname "$dest_path")"
          cp /tmp/metrics.json "$dest_path"
          git add "$dest_path"
          git commit -m "chore(metrics): update from ${{ github.repository }}"
          git push -u origin "$branch"
          gh pr create --title "Update metrics from ${{ github.repository }}" --body "Automated metrics update" --base main --head "$branch"

