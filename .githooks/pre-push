#!/usr/bin/env bash

# Pre-push secret scan for high-signal token/key patterns.
# Bypass with SKIP_SECRET_SCAN=1 if you need to push in an emergency.

if [ "${SKIP_SECRET_SCAN:-}" = "1" ]; then
  echo "SKIP_SECRET_SCAN=1 set; skipping secret scan." >&2
  exit 0
fi

remote_name="${1:-}"
remote_url="${2:-}"

pattern='AKIA[0-9A-Z]{16}|ASIA[0-9A-Z]{16}|AIza[0-9A-Za-z_-]{20,}|sk-ant-[A-Za-z0-9-]{10,}|sk-[A-Za-z0-9]{20,}|xox[baprs]-[0-9A-Za-z-]{10,}|gh[pousr]_[0-9A-Za-z]{20,}|-----BEGIN (RSA|EC|OPENSSH) PRIVATE KEY-----|BEGIN PRIVATE KEY|ya29\.[0-9A-Za-z_-]{10,}|sk_(live|test)_[0-9A-Za-z]{10,}|OPENWEATHERMAP_API_KEY=.*[0-9a-f]{32}'

has_findings=0

while read -r local_ref local_sha remote_ref remote_sha; do
  # Skip deletes.
  if [ "${local_sha}" = "0000000000000000000000000000000000000000" ]; then
    continue
  fi

  if [ "${remote_sha}" = "0000000000000000000000000000000000000000" ]; then
    revs="$(git rev-list "${local_sha}")"
  else
    revs="$(git rev-list "${remote_sha}..${local_sha}")"
  fi

  for commit in ${revs}; do
    matches="$(git grep -n -I -E "${pattern}" "${commit}" -- . ":(exclude).githooks/pre-push" || true)"
    if [ -n "${matches}" ]; then
      echo "Potential secret(s) detected in commit ${commit} (${local_ref}) to ${remote_name} ${remote_url}:" >&2
      echo "${matches}" >&2
      has_findings=1
    fi
  done
done

if [ "${has_findings}" -ne 0 ]; then
  echo "Push blocked due to potential secrets. If this is a false positive, set SKIP_SECRET_SCAN=1 to bypass." >&2
  exit 1
fi

exit 0
